---
title: "VCF validation - With Hap.py and GIAB data"
author: "Clalit Genomics"
date: "11/8/2021"
output: 
  html_document:
    theme: united
    toc: true
    toc_float: true
    fig_width: 12
    fig_height: 8
---

```{r render_report,eval=F,echo=F}
library(rmarkdown)
output_dir <- "/media/SSD/Bioinformatics/Projects/sequencing_validation/sequencing_validation_project/output/reports"
render('/media/SSD/Bioinformatics/Projects/sequencing_validation/sequencing_validation_project/src/sequencing_validation_analysis.Rmd', output_dir = output_dir,output_file = sprintf('vcf_validation_report.%s.html',Sys.Date()))
```

```{r var_setup, include=TRUE,echo=1:3}
happy_path<-'/media/SSD/Bioinformatics/Tools/hap.py-build/bin/hap.py'
reference<-'/media/SSD/Bioinformatics/Databases/hg19/hg19.fa'
#target_region<-'/media/SSD/Bioinformatics/Databases/idt/xgen-exome-research-panel-v2-targets-hg19.bed'
target_region<-'/media/SSD/Bioinformatics/Projects/sequencing_validation/sequencing_validation_project/data/targets/idt_twist_agilent_union.bed'
#target_region<-NA  # NA - means that there is no target region - run the analysis on the whole genome

vcf_stats=F # whether or not to perform vcf stats collection
```

```{r markdown_setup,include=FALSE}
project_dir<-'/media/SSD/Bioinformatics/Projects/sequencing_validation/sequencing_validation_project/'
knitr::opts_knit$set(root.dir='/media/SSD/Bioinformatics/Projects/sequencing_validation/sequencing_validation_project/')
knitr::opts_chunk$set(echo = F)
library(ProjectTemplate)
setwd(project_dir)
load.project()
```

```{r run_happy,eval=TRUE,echo=FALSE,results=FALSE}

for (i in 1:nrow(samples_sheet)) {
  sample <- samples_sheet %>% slice(i)
  giab_ref <- giab_sheet %>% filter(name == sample$truth)
  truth <- giab_ref %>% pull(vcf)
  fp_bed <- giab_ref %>% pull(false_positive)
  query <- sample %>% pull(query_path)
  output_prefix <- sample %>% pull(query_name)
  if (is_sample_already_analyzed(output_prefix)) {
    next
  }# make sure sample was not already ran
  info(logger, print(
    sprintf(
      'Analyzing %s, comparing against %s..',
      output_prefix,
      giab_ref$name
    )
  ))
  #message(sprintf('Analyzing %s, comparing against %s..',output_prefix,giab_ref$name))
  run_happy(
    happy_path,
    truth,
    query,
    reference = reference,
    target_region = target_region,
    fp_bed = fp_bed,
    output_prefix = output_prefix
  )
  info(logger, print(sprintf('Done analyzing %s.', output_prefix)))
}

```

# Sample sheet

```{r sample_sheet_table}
DT::datatable(samples_sheet,
              options=list(scrollX=T),
              filter = list(position = 'top', clear = FALSE))
```

# Stratifications 

```{r stratifications_stats}

DT::datatable(strat_files_stats,
              options=list(scrollX=T),
              filter = list(position = 'top', clear = FALSE))
```

# VCF stats

```{r vcf_stats,out.width="150%",include=TRUE,results='hide',message=FALSE,warnings=FALSE}
if (vcf_stats){
  info(logger,print(sprintf('Producing VCF coverage plot..')))
  all_vcfs<-read_all_vcfs(samples_sheet)
  vcf_coverage_plot<-plot_vcfs_coverage(all_vcfs)
  vcf_coverage_plot
}
```

# Hap.py results: All samples

```{r happy_results_table,eval=T}
# retrieve the happy outcome files
happy_results<-collect_happy_results(samples_sheet)
DT::datatable(happy_results,
              extensions = 'Buttons', 
              options=list(scrollX=T,dom = 'Bfrtip',buttons = c('copy', 'csv', 'excel')),
              filter = list(position = 'top', clear = FALSE))
```

# Hap.py results: Per Sample {.tabset}

```{r happy_results_per_sample,eval=T, results='asis',warning=F}
# retrieve the happy outcome files
happy_results<-collect_happy_results(samples_sheet)
for (sample_name in unique(happy_results$query_name)){
  cat('## ',sample_name,'\n')
  sample_table<-generate_sample_table(happy_results,sample_name)
  print(tagList(
    DT::datatable(
      sample_table,
      extensions = 'Buttons',
      options = list(
        scrollX = T,
        dom = 'Bfrtip',
        buttons = c('copy', 'csv', 'excel')
      ),
      filter = list(position = 'top', clear = FALSE)
    ),
    br(),
    br()
  ))
  cat('\n\n')
}
cat('\n\n')
```

# Hap.py results: Aggregated

```{r happy_summary_table,eval=T,warning=F,message=F}

# summarize results
happy_summary<-happy_summary_per_group(happy_results)
DT::datatable(
  happy_summary,
  extensions = 'Buttons',
  options = list(
    scrollX = T,
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel')
  ),
  filter = list(position = 'top', clear = FALSE)
)

```


# Hap.py results: Plots {.tabset}

```{r happy_plots, results='asis',eval=T,out.width='150%'}
# Plot the results
for (subset in unique(happy_results$Subset)){
  if (subset=='TS_boundary'){next}
  cat('## Subset:',subset,'\n')
  plot_happy_results(happy_results,
             query_group_name=NA,
             subset = c(subset),
             subtype = c('*'),
             filter = c('PASS'),
             var_type = c('SNP','INDEL'),
             facet_by=c())
  cat('\n\n')
}

for (subtype in unique(happy_results$Subtype)){
  if (grepl('^C',subtype)){next}
  cat('## Subtype:',subtype,'\n')
  plot_happy_results(happy_results,
             query_group_name=NA,
             subset = c('*'),
             subtype = c(subtype),
             filter = c('PASS'),
             var_type = c('SNP','INDEL'),
             facet_by=c())
  cat('\n\n')
}
```